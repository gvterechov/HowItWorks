<script>
  $(function() {

    // не показывать модальное окно в режиме preview
    if (window.location.href.includes('preview'))
      return;

    $('.ui.modal.student').modal('setting', 'closable', false);

    if (localStorage.student_name == null || localStorage.student_name == '') {
      $('.ui.modal.student').modal('show');
    } else {
      createAttempt();
      showUserName();
    }

    // Создаем попытку, когда студент ввел имя
    $('#student_modal_submit_btn').click(function(){
      let $elem = $(this);
      $elem.toggleClass('loading');

      localStorage.student_name = $('#student_name').val();

      createAttempt({
        success: function () {
          $('.ui.modal.student').modal('hide');
          showUserName();
        },
        complete: function () {
          // TODO разблокировать нажатие на элементы алгоритма
          $elem.toggleClass('loading');
        }
      });
    });

    function createAttempt(callbacks = {}) {
      $.ajax({
        method: "POST",
        url: '/attempts.json',
        data: {
          attempt: {
            student_name: localStorage.student_name,
            task_type: $('#task_type').val(),
            task_token: $('#task_token').val()
          }
        },
        // dataType: "json",
        error: function (jqXHR) {
          // TODO показать сообщение об ошибке
          alert('error');
        },
        success: function (data) {
          $('#attempt_id').val(data['id']);
          if (callbacks['success']) {
            callbacks['success']();
          }
        },
        complete: callbacks['complete']
      });
    }

    function showUserName() {
      let $user_name = $('#user_name');
      $user_name.text(localStorage.student_name);
      $user_name.show();
    }
  });
</script>
